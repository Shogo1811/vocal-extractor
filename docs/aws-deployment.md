# AWS EC2 デプロイ手順

Vocal ExtractorアプリをAWS EC2にデプロイする手順です。

## 前提条件

- AWSアカウントを持っていること
- GitHubリポジトリ: https://github.com/Shogo1811/vocal-extractor

---

## Step 1: AWSコンソールにログイン

1. https://console.aws.amazon.com/ にアクセス
2. ログイン後、右上のリージョンを **アジアパシフィック（東京）ap-northeast-1** に設定

---

## Step 2: EC2ダッシュボードへ移動

1. 上部の検索バーで「EC2」と入力
2. 「EC2」をクリック
3. 左メニューまたは中央の「インスタンスを起動」ボタンをクリック

---

## Step 3: インスタンスの設定

### 3-1. 名前とタグ

| 項目 | 設定値 |
|------|--------|
| 名前 | `vocal-extractor` |

### 3-2. アプリケーションおよび OS イメージ (AMI)

| 項目 | 設定値 |
|------|--------|
| AMI | **Ubuntu Server 22.04 LTS (HVM), SSD Volume Type** |
| アーキテクチャ | 64ビット (x86) |

> クイックスタートから「Ubuntu」を選択し、Ubuntu Server 22.04 LTSを選んでください。

### 3-3. インスタンスタイプ

| 項目 | 設定値 |
|------|--------|
| インスタンスタイプ | **t3.medium** |

> t3.medium: 2 vCPU, 4 GiB メモリ（音声処理に必要な最低スペック）

### 3-4. キーペア（ログイン）

**新しいキーペアを作成する場合:**

1. 「新しいキーペアの作成」をクリック
2. 以下を入力:
   - キーペア名: `vocal-extractor-key`
   - キーペアのタイプ: RSA
   - プライベートキーファイル形式: `.pem`
3. 「キーペアを作成」をクリック
4. `.pem`ファイルが自動ダウンロードされる（大切に保管）

> EC2 Instance Connectを使う場合は「キーペアなしで続行」も可能です。

### 3-5. ネットワーク設定

「編集」をクリックして以下を設定:

| 項目 | 設定値 |
|------|--------|
| VPC | デフォルトVPC |
| サブネット | 優先順位なし（デフォルト） |
| パブリック IP の自動割り当て | **有効化** |
| ファイアウォール (セキュリティグループ) | セキュリティグループを作成する |
| セキュリティグループ名 | `vocal-extractor-sg` |

**インバウンドセキュリティグループのルール:**

「セキュリティグループルールを追加」を2回クリックして、合計3つのルールを作成:

| タイプ | ポート範囲 | ソースタイプ | 説明 |
|--------|-----------|--------------|------|
| ssh | 22 | 自分のIP | SSH接続用 |
| HTTP | 80 | 任意の場所 (0.0.0.0/0) | Web用（将来） |
| カスタム TCP | 8000 | 任意の場所 (0.0.0.0/0) | アプリ用 |

### 3-6. ストレージを設定

| 項目 | 設定値 |
|------|--------|
| サイズ | **30 GiB** |
| ボリュームタイプ | gp3 |

### 3-7. 高度な詳細（オプション）

特に変更不要。デフォルトのまま。

---

## Step 4: インスタンスを起動

1. 右側の「概要」パネルで設定を確認
2. 「インスタンスを起動」ボタンをクリック
3. 「インスタンスを表示」をクリック

---

## Step 5: インスタンスに接続

### 5-1. パブリックIPの確認

1. インスタンス一覧から`vocal-extractor`を選択
2. 「パブリック IPv4 アドレス」をメモ（例: `54.xxx.xxx.xxx`）

### 5-2. EC2 Instance Connectで接続

1. インスタンスを選択した状態で「接続」ボタンをクリック
2. 「EC2 Instance Connect」タブを選択
3. ユーザー名: `ubuntu`（デフォルト）
4. 「接続」をクリック

ブラウザ内でターミナルが開きます。

---

## Step 6: アプリケーションのセットアップ

ターミナルで以下のコマンドを順番に実行:

### 6-1. リポジトリをクローン

```bash
git clone https://github.com/Shogo1811/vocal-extractor.git
```

### 6-2. セットアップスクリプトを実行

```bash
cd vocal-extractor
sudo bash scripts/ec2-setup.sh
```

以下のような出力が表示されます:
```
=== Vocal Extractor EC2 セットアップ ===
[1/5] システムアップデート中...
[2/5] Docker インストール中...
[3/5] Docker 権限設定中...
[4/5] スワップ領域設定中...
[5/5] ファイアウォール設定中...

=== セットアップ完了 ===
```

### 6-3. 一度切断して再接続

Docker権限を反映するため、一度切断して再接続が必要です。

1. ターミナルを閉じる（またはブラウザタブを閉じる）
2. 再度「接続」→「EC2 Instance Connect」で接続

---

## Step 7: アプリケーションを起動

再接続後、以下を実行:

```bash
cd vocal-extractor
docker compose up -d --build
```

初回は Docker イメージのビルドに **10〜15分** かかります。

進捗確認:
```bash
docker compose logs -f
```

（Ctrl+C で終了）

---

## Step 8: 動作確認

ブラウザで以下のURLにアクセス:

```
http://<パブリックIPアドレス>:8000
```

例: `http://54.xxx.xxx.xxx:8000`

Vocal Extractorの画面が表示されれば成功です。

---

## 運用コマンド

### アプリの状態確認
```bash
docker compose ps
```

### ログ確認
```bash
docker compose logs -f
```

### アプリ再起動
```bash
docker compose restart
```

### アプリ停止
```bash
docker compose down
```

### コード更新時
```bash
cd vocal-extractor
git pull
docker compose up -d --build
```

---

## コスト目安

| 項目 | 月額（東京リージョン） |
|------|------------------------|
| EC2 t3.medium | 約 $30〜35 |
| EBS 30GB gp3 | 約 $3 |
| データ転送 | 使用量による |
| **合計** | **約 $35〜40/月** |

> 使わないときはインスタンスを**停止**するとEC2料金がかかりません（EBS料金のみ）。

---

## トラブルシューティング

### 接続できない場合

1. セキュリティグループでポート8000が開放されているか確認
2. パブリックIPが割り当てられているか確認
3. `docker compose ps`でコンテナが起動しているか確認

### メモリ不足エラー

```bash
# スワップ確認
free -h

# スワップ追加（未設定の場合）
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### Docker権限エラー

```bash
sudo usermod -aG docker ubuntu
# その後、再ログイン
```
